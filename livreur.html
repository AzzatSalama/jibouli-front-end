<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Person Dashboard</title>
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- SweetAlert Library -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div id="app" class="min-h-screen bg-gray-100">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <!-- Add Client Button -->
                <button @click="showAddClientModal = true"
                    class="px-1.5 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fas fa-user-plus"></i>
                    Client
                </button>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 hidden md:block">Tableau de bord du livreur</h1>
                    <p class="text-gray-600">Solde: {{ formatBalance(deliveryPerson.balance) }} DH</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-700">Available:</span>
                    <button @click="toggleAvailability" :class="[isAvailable ? 'bg-green-500' : 'bg-gray-200']"
                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none">
                        <span :class="[isAvailable ? 'translate-x-6' : 'translate-x-1']"
                            class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" />
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Balance warning modal -->
            <div v-if="showBalanceWarning && !showBalanceError"
                class="bg-orange-100 text-orange-500 p-4 flex items-center rounded-lg justify-between mb-6">
                <div class="flex-1 text-center">
                    ‚ö†Ô∏è Votre solde est faible ({{ deliveryPerson.balance }} DH). Veuillez recharger votre compte
                    bient√¥t.
                </div>
                <button @click="showBalanceWarning = false"
                    class="ml-4 p-1 hover:bg-orange-500 hover:text-white border border-orange-500 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Balance error modal -->
            <div v-if="showBalanceError"
                class="bg-red-100 text-red-500 p-6 flex items-center rounded-lg justify-between mb-6">
                <div class="flex-1 text-center">
                    ‚ö†Ô∏è Votre solde est √©puis√©. Veuillez recharger votre compte.
                </div>
            </div>


            <!-- if no order is accepted and ther's no order yet -->
            <div v-if="!acceptedOrder && pendingOrders.length==0 && !showBalanceError"
                class="p-6 bg-gray-200 text-gray-800 font-bold w-full rounded-lg text-center items-center">
                ü§∑üèª‚Äç‚ôÇÔ∏èü§∑üèª‚Äç‚ôÇÔ∏èAucun
                commande pour le
                momantü§∑üèª‚Äç‚ôÇÔ∏èü§∑üèª‚Äç‚ôÇÔ∏è</div>
            <!-- Accepted Order -->
            <div v-if="acceptedOrder" class="mb-8">
                <div
                    class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 transform transition-all hover:shadow-2xl">
                    <!-- Header Section -->
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                            </svg>
                            Commande en Cours
                        </h2>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold" :class="{
                      'bg-green-100 text-green-700': acceptedOrder.status === 'delivered',
                      'bg-red-100 text-red-700': acceptedOrder.status === 'canceled',
                      'bg-blue-100 text-blue-700': acceptedOrder.status === 'accepted'
                  }">
                            {{ acceptedOrder.status.toUpperCase() }}
                        </span>
                    </div>

                    <!-- Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 lg:gap-6 mb-6">
                        <span class="col-span-1 lg:col-span-2">Cr√©e le: {{formatDate(acceptedOrder.created_at)}}</span>
                        <!-- Client Card -->
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <h3 class="text-sm font-semibold text-gray-500 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                INFORMATION CLIENT
                            </h3>
                            <div class="space-y-2">
                                <p class="text-gray-700"><span class="font-medium">Nom:</span> {{
                                    acceptedOrder.client.client_name }}</p>
                                <p class="text-gray-700"><span class="font-medium">T√©l:</span> {{
                                    acceptedOrder.client.client_phone }}</p>
                                <p class="text-gray-700"><span class="font-medium">Adresse:</span> {{
                                    acceptedOrder.client.client_address }}</p>
                            </div>
                        </div>

                        <!-- Order Card -->
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <h3 class="text-sm font-semibold text-gray-500 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                D√âTAILS DE COMMANDE
                            </h3>
                            <div class="space-y-2">
                                <p class="text-gray-700"><span class="font-medium">Demande:</span> {{
                                    acceptedOrder.request }}</p>
                                <p class="text-gray-700"><span class="font-medium">Notes Client:</span> {{
                                    acceptedOrder.client_notes || '-' }}</p>
                                <p class="text-gray-700"><span class="font-medium">Notes Centre:</span> {{
                                    acceptedOrder.employee_notes || '-' }}</p>
                            </div>
                        </div>

                        <!-- Partner Card -->
                        <div v-if="acceptedOrder.partner"
                            class="bg-gray-50 p-4 rounded-xl border border-gray-100 lg:col-span-2">
                            <h3 class="text-sm font-semibold text-gray-500 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5m-4 0h4" />
                                </svg>
                                Informations du partenaire
                            </h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="space-y-2">
                                        <p class="text-gray-700">
                                            <span class="font-medium">Nom:</span> {{ acceptedOrder.partner.name }}
                                        </p>
                                        <p class="text-gray-700 flex items-center gap-2">
                                            <span class="font-medium">T√©l: </span>
                                            {{ acceptedOrder.partner.phone }}
                                            <a :href="`tel:${acceptedOrder.partner.phone}`"
                                                class="text-blue-600 hover:text-blue-800 bg-blue-200 px-2 py-1.5 rounded-full">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                </svg>
                                            </a>
                                        </p>
                                        <p class="text-gray-700">
                                            <span class="font-medium">Type: </span>
                                            <span class="capitalize">{{ acceptedOrder.partner.type }}</span>
                                        </p>
                                    </div>
                                </div>
                                <p class="text-gray-700 flex flex-row items-center justify-between">
                                    <span>
                                        <span class="font-medium">Adresse:</span>
                                        {{ acceptedOrder.partner.address }}
                                    </span>
                                    <a v-if="acceptedOrder.partner.lat && acceptedOrder.partner.lang"
                                        :href="`https://www.google.com/maps/dir/?api=1&destination=${acceptedOrder.partner.lat},${acceptedOrder.partner.lang}`"
                                        target="_blank"
                                        class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition flex items-center">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                        </svg>
                                    </a>
                                </p>
                            </div>
                        </div>

                    </div>

                    <!-- Action Section -->
                    <div class="border-t pt-6">
                        <div class="flex flex-col sm:flex-row items-center gap-4 justify-between">
                            <div class="flex gap-3 w-full sm:w-auto">
                                <a :href="`tel:${acceptedOrder.client.client_phone}`"
                                    class="flex-1 flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl shadow-sm hover:shadow-md transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                    </svg>
                                    Appeler
                                </a>

                                <a :href="whatsappLink" target="_blank"
                                    class="flex-1 flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-sm hover:shadow-md transition-all">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884" />
                                    </svg>
                                    WhatsApp
                                </a>
                            </div>
                            <div class="flex gap-3">
                                <button @click="rejectOrder(acceptedOrder.id)"
                                    class="flex-1 flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl shadow-sm hover:shadow-md transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Rejeter
                                </button>
                                <select v-model="selectedStatus" @change="updateOrderStatus"
                                    class="w-full sm:w-auto px-5 py-3 border-2 border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none">
                                    <option value="accepted">En Cours</option>
                                    <option value="delivered">Marquer comme Livr√©</option>
                                    <option value="canceled">Annuler Commande</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Orders Grid -->
            <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="order in pendingOrders.filter(order => !rejectedOrders.includes(order.id))" :key="order.id"
                    class="bg-white rounded-lg shadow p-6">
                    <div class="space-y-4">
                        <h3 class="font-medium">Commande #{{ order.id }}</h3>
                        <p class="text-gray-600">{{ formatDate(order.created_at) }}</p>
                        <p><span class="font-medium">Demande du client:</span> {{ order.request }}</p>
                        <p><span class="font-medium">Adress:</span> {{ order.client.client_address || "" }}</p>
                        <button @click="acceptOrder(order.id)"
                            class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Accept Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rejected Orders Grid -->
            <div v-if="rejectedOrders.length > 0" class="my-6">
                <h3 class="text-2xl font-bold text-red-600">üö´ Commandes Rejet√©es</h3>
            </div>

            <div v-if="rejectedOrders.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="order in pendingOrders.filter(order => rejectedOrders.includes(order.id))" :key="order.id"
                    class="bg-red-100 rounded-lg shadow p-6">
                    <div class="space-y-4">
                        <h3 class="font-medium text-red-700">Commande Rejet√©e #{{ order.id }}</h3>
                        <p class="text-gray-600">{{ formatDate(order.created_at) }}</p>
                        <p><span class="font-medium">Demande du client:</span> {{ order.request }}</p>
                        <p><span class="font-medium">Adresse:</span> {{ order.client.client_address || "" }}</p>
                        <button @click="removeRejectedOrder(order.id)"
                            class="w-full px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            Supprimer de la liste rejet√©e
                        </button>
                    </div>
                </div>
            </div>

            <!-- driver notes modal template -->
            <div id="notesModal" v-if="showNotesModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4">Notes de livraison</h3>
                    <textarea v-model="driverNotes" class="w-full p-2 border rounded mb-4" :placeholder="selectedStatus === 'canceled' 
                ? 'Raison de l\'annulation (facultatif)...' 
                : 'Notes de livraison (facultatif)...'" rows="4"></textarea>
                    <div class="flex justify-end space-x-4">
                        <button @click="showNotesModal = false; driverNotes = '';"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                            Annuler
                        </button>
                        <button @click="submitStatusWithNotes"
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Confirmer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Client Modal -->
            <div v-if="showAddClientModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-xl font-bold mb-4">Nouveau Client</h3>
                    <form @submit.prevent="addNewClient">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nom Complet</label>
                                <input v-model="newClient.client_name" type="text" required
                                    class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                                <input v-model="newClient.client_phone" type="tel" required placeholder="+212XXXXXXXX"
                                    class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Adresse Compl√®te</label>
                                <textarea v-model="newClient.client_address" required rows="3"
                                    class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2"></textarea>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" @click="closeAddClientModal"
                                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                Annuler
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Cr√©er Client
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    showBalanceWarning: false,
                    showBalanceError: false,
                    apiUrl: "http://jibouli.test/api",
                    token: "",
                    deliveryPerson: {},
                    isAvailable: false,
                    pendingOrders: [],
                    acceptedOrder: null,
                    selectedStatus: 'accepted',
                    rejectedOrders: [],
                    locationInterval: null,
                    lastPendingOrdersHash: null,
                    shouldPoll: true,

                    showNotesModal: false,
                    driverNotes: '',
                    canToggleVisibility: false,

                    showAddClientModal: false,
                    newClient: {
                        client_name: '',
                        client_phone: '',
                        client_address: ''
                    },

                    isTrackingActive: false,
                    trackingSessionId: null,

                }
            },
            computed: {
                whatsappLink() {
                    if (!this.acceptedOrder) return '';
                    const phone = this.acceptedOrder.client.client_phone.replace(/[^0-9]/g, '');
                    return `https://wa.me/${phone}`;
                }
            },
            methods: {
                formatBalance(balance) {
                    return parseFloat(balance).toFixed(2);
                },
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString();
                },

                // SweetAlert helpers
                showSuccess(message) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Succ√®s',
                        text: message,
                        confirmButtonText: 'OK'
                    });
                },
                showError(message) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: message,
                        confirmButtonText: 'OK'
                    });
                },

                showConfirmation(message) {
                    return Swal.fire({
                        title: 'Confirmation',
                        text: message,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Oui',
                        cancelButtonText: 'Non'
                    });
                },

                async loadData() {
                    try {
                        // Fetch delivery person info
                        const personRes = await axios.get(this.apiUrl + '/delivery/me');
                        this.deliveryPerson = personRes.data;
                        console.log(this.deliveryPerson)
                        this.isAvailable = this.deliveryPerson.delivery_person.is_available;
                        this.canToggleVisibility = true

                        //if balance is 2 then stop everything
                        if (this.deliveryPerson.balance <= 2) {
                            this.showBalanceError = true;
                            this.isAvailable = false
                            return
                        }

                        // Check balance and show warning
                        if (this.deliveryPerson.balance <= 10) {
                            this.showBalanceWarning = true;
                        }

                        // Check for active orders
                        if (personRes.data.active_orders && personRes.data.active_orders.length > 0) {
                            this.acceptedOrder = personRes.data.active_orders[0];
                            // this.startLocationTracking();
                            return; // Skip fetching pending orders if active order exists
                        }

                        // Only fetch pending orders if available and no active order
                        if (this.isAvailable) {
                            const ordersRes = await axios.get(this.apiUrl + '/orders/pending');
                            this.processPendingOrders(ordersRes.data);
                        }
                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            // Handle 401 error specifically
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur!',
                                text: "Vous n'√™tes pas connect√©.",
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = "index.html";
                            });
                        } else {
                            this.showError(error.response?.data?.message || 'Erreur de chargement des donn√©es');
                            console.error('Error loading data:', error);
                        }
                    }
                },

                processPendingOrders(newOrders) {
                    const newHash = JSON.stringify(newOrders);
                    if (newHash !== this.lastPendingOrdersHash) {
                        this.pendingOrders = newOrders;
                        this.lastPendingOrdersHash = newHash;

                        if (newOrders.length > this.pendingOrders.length) {
                            this.showSuccess('Nouvelles commandes disponibles !');
                        }
                    }
                },

                async toggleAvailability() {
                    if (!this.canToggleVisibility) return
                    try {
                        if (this.deliveryPerson.balance <= 2) {
                            this.showError("‚ö†Ô∏è Votre solde est √©puis√©. Veuillez recharger votre compte.")
                            return
                        }
                        const newAvailability = !this.isAvailable;

                        const result = await this.showConfirmation(
                            `Voulez-vous vraiment vous rendre ${newAvailability ? 'disponible' : 'indisponible'} ?`
                        );

                        if (result.isConfirmed) {
                            await axios.put(this.apiUrl + '/delivery/availability', {
                                is_available: newAvailability
                            });
                            this.isAvailable = newAvailability;

                            if (newAvailability) {
                                await this.loadData();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Succ√®s',
                                    text: 'Statut de disponibilit√© mis √† jour',
                                    wait: 1100
                                });
                            } else {
                                this.pendingOrders = [];
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Succ√®s',
                                    text: 'Vous √™tes maintenant indisponible',
                                    wait: 1100
                                });
                            }
                        }
                    } catch (error) {
                        this.showError(error.response?.data?.message || 'Erreur de mise √† jour de disponibilit√©');
                        console.error('Error updating availability:', error);
                    }
                },

                async acceptOrder(orderId) {
                    try {
                        const result = await this.showConfirmation('Voulez-vous vraiment accepter cette commande ?');
                        if (!result.isConfirmed) return;

                        const response = await axios.post(this.apiUrl + `/orders/${orderId}/accept`);
                        // console.log('accepted order response:' + response.data)
                        this.acceptedOrder = response.data.order;
                        this.pendingOrders = [];
                        this.canToggleVisibility = false
                        this.showSuccess('Commande accept√©e avec succ√®s');
                        // this.startLocationTracking();
                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            // Handle 401 error specifically
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur!',
                                text: "Vous n'√™tes pas connect√©.",
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = "index.html";
                            });
                        } else {
                            this.showError(error.response?.data?.message || 'Erreur de chargement des donn√©es');
                            console.error('Error loading data:', error);
                        }
                    }
                },

                async updateOrderStatus() {
                    try {
                        const result = await this.showConfirmation(
                            `Confirmez-vous le statut "${this.selectedStatus}" pour cette commande ?`
                        );
                        if (!result.isConfirmed) {
                            this.selectedStatus = "accepted"; // Reset to current status
                            return;
                        }

                        // Show notes modal for any status change
                        this.showNotesModal = true;

                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            // Handle 401 error specifically
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur!',
                                text: "Vous n'√™tes pas connect√©.",
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = "index.html";
                            });
                        } else {
                            this.showError(error.response?.data?.message || 'Erreur de chargement des donn√©es');
                            console.error('Error loading data:', error);
                        }
                    }
                },

                async rejectOrder() {
                    try {
                        const result = await this.showConfirmation('Voulez-vous vraiment rejeter cette commande ?');
                        if (!result.isConfirmed) return;

                        await axios.post(this.apiUrl + `/order/${this.acceptedOrder.id}/reject`);
                        this.showSuccess('Commande rejet√©e avec succ√®s');

                        // Add the rejected order ID to the rejectedOrders array
                        this.rejectedOrders.push(this.acceptedOrder.id);

                        // Save the rejectedOrders array to localStorage
                        localStorage.setItem('rejectedOrders', JSON.stringify(this.rejectedOrders));

                        this.acceptedOrder = null;
                        // this.stopLocationTracking();
                        this.loadData();
                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur!',
                                text: "Vous n'√™tes pas connect√©.",
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = "index.html";
                            });
                        } else {
                            this.showError(error.response?.data?.message || 'Erreur lors du rejet de la commande');
                            console.error('Error rejecting order:', error);
                        }
                    }
                },
                removeRejectedOrder(orderId) {
                    // Remove the order ID from the rejectedOrders array
                    this.rejectedOrders = this.rejectedOrders.filter(id => id !== orderId);

                    // Update the localStorage with the new rejectedOrders array
                    localStorage.setItem('rejectedOrders', JSON.stringify(this.rejectedOrders));
                },

                async submitStatusWithNotes() {
                    try {
                        const swal = Swal.fire({
                            title: 'En cours',
                            text: 'Veuillez patienter...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        this.showNotesModal = false;
                        await axios.post(
                            this.apiUrl + `/orders/${this.acceptedOrder.id}/status`,
                            {
                                status: this.selectedStatus,
                                driver_notes: this.driverNotes
                            }
                        );

                        // Reset notes field
                        this.driverNotes = '';

                        // Handle post-update logic
                        if (this.selectedStatus === 'delivered') {
                            this.deliveryPerson.balance -= 2;
                            this.showSuccess('Commande marqu√©e comme livr√©e');
                        }

                        if (this.selectedStatus === 'canceled') {
                            this.showSuccess('Commande annul√©e');
                        }

                        this.acceptedOrder = null;
                        // this.stopLocationTracking();
                        await this.loadData();

                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            // Handle 401 error specifically
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur!',
                                text: "Vous n'√™tes pas connect√©.",
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = "index.html";
                            });
                        } else {
                            this.showError(error.response?.data?.message || 'Erreur d\'envoi des commentaires');
                            console.error('Error loading data:', error);
                        }
                    }
                },

                //adding client
                async addNewClient() {
                    // Frontend validation
                    if (!this.validateClientForm()) return;

                    try {
                        const swal = Swal.fire({
                            title: 'En cours',
                            text: 'Veuillez patienter...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        const response = await axios.post(this.apiUrl + '/client', this.newClient);

                        Swal.fire({
                            icon: 'success',
                            title: 'Client ajout√©',
                            text: 'Le nouveau client a √©t√© cr√©√© avec succ√®s',
                            timer: 800,
                            showConfirmButton: false
                        });

                        this.closeAddClientModal();
                    } catch (error) {
                        const errorMessage = error.response?.data || error.message || '√âchec de la cr√©ation du client';
                        Swal.fire({
                            icon: 'error',
                            title: 'Erreur',
                            text: typeof errorMessage === 'object'
                                ? Object.values(errorMessage).flat().join(', ')
                                : errorMessage,
                            confirmButtonText: 'OK'
                        });
                    }
                },

                validateClientForm() {
                    // Check all fields are filled
                    if (!this.newClient.client_name.trim() ||
                        !this.newClient.client_phone.trim() ||
                        !this.newClient.client_address.trim()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Champs requis',
                            text: 'Veuillez remplir tous les champs',
                            confirmButtonText: 'OK'
                        });
                        return false;
                    }

                    // Validate phone format
                    const phoneRegex = /^\+?[1-9]\d{1,14}$/;
                    if (!phoneRegex.test(this.newClient.client_phone)) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Format t√©l√©phone invalide',
                            text: 'Veuillez entrer un num√©ro de t√©l√©phone valide au format international (ex: +1234567890)',
                            confirmButtonText: 'OK'
                        });
                        return false;
                    }

                    return true;
                },

                closeAddClientModal() {
                    this.showAddClientModal = false;
                    this.resetClientForm();
                },

                resetClientForm() {
                    this.newClient = {
                        client_name: '',
                        client_phone: '',
                        client_address: ''
                    };
                },

                startOrderPolling() {
                    this.orderPollInterval = setInterval(async () => {
                        if (this.shouldPoll && !this.acceptedOrder && this.isAvailable && this.deliveryPerson.balance > 2) {
                            try {
                                console.log('fteching orders...')
                                const response = await axios.get(this.apiUrl + '/orders/pending');
                                this.processPendingOrders(response.data);
                            } catch (error) {
                                console.error('Error polling orders:', error);
                            }
                        } else {
                            this.isAvailable = false
                        }
                    }, 5000);//refetch every 5 seconds
                },

                // //location tracking logic
                // async startLocationTracking() {
                //     if ('geolocation' in navigator) {
                //         this.isTrackingActive = true;
                //         this.trackingSessionId = Date.now(); // Unique session ID

                //         // Register service worker
                //         if ('serviceWorker' in navigator) {
                //             try {
                //                 this.registration = await navigator.serviceWorker.register('/livreurSW.js');
                //             } catch (error) {
                //                 console.error('SW registration failed:', error);
                //             }
                //         }

                //         navigator.geolocation.getCurrentPosition(async () => {
                //             this.geoWatchId = navigator.geolocation.watchPosition(
                //                 async (position) => {
                //                     if (!this.isTrackingActive) return;

                //                     const locationData = {
                //                         sessionId: this.trackingSessionId,
                //                         latitude: position.coords.latitude,
                //                         longitude: position.coords.longitude,
                //                         timestamp: Date.now()
                //                     };

                //                     try {
                //                         // Store in IndexedDB first
                //                         await this.storeLocationInDB(locationData);

                //                         // Try immediate send
                //                         await axios.post(this.apiUrl + '/delivery/location', locationData);
                //                         await this.clearSentLocations();
                //                     } catch (error) {
                //                         console.log('Queueing for background sync');
                //                         if (this.registration?.sync) {
                //                             await this.registration.sync.register('location-update');
                //                         }
                //                     }
                //                 },
                //                 (error) => console.error('Geolocation error:', error),
                //                 { enableHighAccuracy: true, maximumAge: 15000 }
                //             );
                //         });
                //     }
                // },

                // async stopLocationTracking() {
                //     // Clear all tracking mechanisms
                //     this.isTrackingActive = false;

                //     // 1. Clear geolocation watch
                //     if (this.geoWatchId) {
                //         navigator.geolocation.clearWatch(this.geoWatchId);
                //         this.geoWatchId = null;
                //     }

                //     // 2. Clear pending background sync
                //     if (this.registration?.sync) {
                //         const tags = await this.registration.sync.getTags();
                //         if (tags.includes('location-update')) {
                //             await this.registration.sync.unregister('location-update');
                //         }
                //     }

                //     // 3. Clear IndexedDB locations
                //     const db = await this.openDatabase();
                //     const tx = db.transaction('locations', 'readwrite');
                //     const store = tx.objectStore('locations');
                //     const clearRequest = store.clear();

                //     await new Promise((resolve, reject) => {
                //         clearRequest.onsuccess = resolve;
                //         clearRequest.onerror = reject;
                //     });

                //     // 4. Send final stop notification
                //     try {
                //         await axios.post(this.apiUrl + '/delivery/location/stop', {
                //             sessionId: this.trackingSessionId
                //         });
                //     } catch (error) {
                //         console.error('Stop notification failed:', error);
                //     }

                //     // 5. Unregister service worker if needed
                //     if (this.registration) {
                //         await this.registration.unregister();
                //     }
                // },

                // // Modified storeLocationInDB
                // async storeLocationInDB(locationData) {
                //     const db = await this.openDatabase();
                //     const tx = db.transaction('locations', 'readwrite');
                //     const store = tx.objectStore('locations');
                //     await store.put(locationData);
                // },

                // // New method to clear sent locations
                // async clearSentLocations() {
                //     const db = await this.openDatabase();
                //     const tx = db.transaction('locations', 'readwrite');
                //     const store = tx.objectStore('locations');
                //     const allKeys = await store.getAllKeys();

                //     await Promise.all(allKeys.map(key => store.delete(key)));
                // }
            },
            mounted() {
                // Get token from localStorage
                this.token = localStorage.getItem('livreurJibouli-token');

                if (!this.token) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£!',
                        text: "ÿ£ŸÜÿ™ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ.",
                        confirmButtonText: 'ÿ≠ÿ≥ŸÜÿß'
                    }).then(() => {
                        window.location.href = "index.html"
                    });
                    return;
                }

                // Set default headers
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
                axios.defaults.headers.common['Accept'] = 'application/json';
                axios.defaults.headers.common['Content-Type'] = 'application/json';

                // Set up axios interceptors
                axios.interceptors.request.use(config => {
                    if (this.token) {
                        config.headers.Authorization = `Bearer ${this.token}`;
                    }
                    return config;
                });

                const storedRejectedOrders = localStorage.getItem('rejectedOrders');
                this.rejectedOrders = storedRejectedOrders ? JSON.parse(storedRejectedOrders) : [];

                // Load initial data
                this.loadData().finally(() => {
                    // Only start polling if available
                    if (this.isAvailable && this.deliveryPerson.balance > 2) {
                        this.startOrderPolling();
                    } else if (!this.isAvailable) {
                        this.isAvailable = false
                    }
                });
            },
            watch: {
                isAvailable(newVal) {
                    this.shouldPoll = newVal;
                    if (newVal) {
                        this.loadData();
                        this.startOrderPolling();
                    } else {
                        this.pendingOrders = [];
                    }
                }
            },
            beforeUnmount() {
                clearInterval(this.orderPollInterval);
                // this.stopLocationTracking();
            }
        }).mount('#app');
    </script>
</body>

</html>